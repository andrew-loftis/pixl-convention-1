
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Putnam Convention & Expo — Interactive Display</title>
  <meta name="theme-color" content="#0E1116" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --text: #e9eef7;
      --muted: #9fb3c8;
      --brand: #00ffa7;
      --brand-2: #60a5fa;
      --danger: #ff6b6b;
      --radius: 16px;
      --blur: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 20% -10%, #1a2230 0%, transparent 60%),
                  radial-gradient(900px 700px at 120% 10%, #101827 0%, transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height:1.35;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow:hidden;
    }

    /* Video stage */
    #stage{
      position:fixed; inset:0;
      background: #000;
      overflow:hidden;
    }
    video.display{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      background:#000;
    }
    video.display.contain{ object-fit:contain; background:#000; }
    video.display.hidden{ opacity:0; pointer-events:none; }

    /* UI Layer */
    #ui{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      pointer-events:none; /* buttons re-enable themselves */
      padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
    }

    .topbar{
      display:flex; align-items:center; gap:12px;
      pointer-events:auto;
      align-self:flex-start;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 999px;
      padding: 8px 12px;
      box-shadow: var(--shadow);
    }
    .brand-dot{ width:10px; height:10px; border-radius:999px; background:linear-gradient(90deg,var(--brand),var(--brand-2)); }
    .title{ font-weight:600; letter-spacing:.2px; font-size:14px; color:var(--muted); }
    .sp{ flex:1; }

    .controls{
      pointer-events:auto;
      display:flex; flex-direction:column; gap:16px;
      align-items:center; justify-content:center;
      margin-bottom: 6vh;
    }

    /* Segmented destination group */
    .segmented{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }
    .segmented .btn{
      --ring: 0 0 0 0 rgba(0,255,167,0);
      position:relative;
      appearance:none;
      border:none;
      padding:14px 18px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color: var(--text);
      box-shadow: var(--shadow), var(--ring);
      cursor:pointer;
      font-weight:600; letter-spacing:.2px;
      display:inline-flex; align-items:center; gap:10px;
      transition: transform .12s ease, background .2s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .segmented .btn:hover{ transform: translateY(-1px); }
    .segmented .btn:active{ transform: translateY(0); }
    .segmented .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .segmented .btn svg{ width:18px; height:18px; opacity:.9; }

    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color: var(--muted);
      font-weight:600;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(0,255,167,.25), rgba(0,255,167,.12));
      color:#041a13;
      text-shadow: 0 1px 0 rgba(255,255,255,.2);
    }
    .btn.active, .btn[aria-current="true"]{
      outline:2px solid rgba(0,255,167,.6);
      outline-offset:2px;
      box-shadow: var(--shadow), 0 0 0 6px rgba(0,255,167,.12) inset;
      background: linear-gradient(180deg, rgba(0,255,167,.32), rgba(0,255,167,.16));
    }
    .btn:focus-visible{
      outline:2px solid #00ff94;
      outline-offset:2px;
    }

    /* Utility bar */
    .utility{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }

    /* Status (debug-only by default) */
    .status{
      pointer-events:auto;
      align-self:flex-end;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px; color:var(--muted);
      max-width: min(50vw, 520px);
      white-space:pre-wrap;
      backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: var(--radius);
      padding: 10px 12px;
      box-shadow: var(--shadow);
      display:none; /* hidden unless debug */
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom: max(24px, env(safe-area-inset-bottom));
      transform: translateX(-50%);
      padding:10px 14px;
      background: rgba(20,25,35,.9);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
      font-size:13px;
      display:none;
    }

    /* Small screens */
    @media (max-width: 640px){
      .title{ display:none; }
    }
  </style>
</head>
<body>
  <div id="stage" aria-live="polite" aria-label="Interactive display video stage">
    <!-- triple-buffer videos -->
    <video id="vidA" class="display" playsinline webkit-playsinline muted preload="auto"></video>
    <video id="vidB" class="display hidden" playsinline webkit-playsinline muted preload="auto"></video>
    <video id="vidBuf" class="display hidden" playsinline webkit-playsinline muted preload="auto"></video>
  </div>

  <div id="ui" role="region" aria-label="Interface controls">
    <div class="topbar">
      <div class="brand-dot" aria-hidden="true"></div>
      <div class="title">Putnam County Convention &amp; Expo — House of KnA · PIXL</div>
    </div>

    <div class="controls">
      <div id="destinations" class="segmented" role="group" aria-label="Destinations"></div>
      <div class="utility">
        <button class="btn secondary" id="btnContain" aria-pressed="false" title="Toggle contain / cover">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M9 9h6v6H9z"/></svg>
          Fit
        </button>
        <button class="btn secondary" id="btnReset" title="Reset to main menu">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path d="M3 12a9 9 0 1 0 3-6.7"/><path d="M3 3v6h6"/></svg>
          Reset
        </button>
        <button class="btn secondary" id="btnMute" aria-pressed="true" title="Toggle sound">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path d="M4 10v4h4l5 4V6l-5 4z"/><path d="M16 9a5 5 0 0 1 0 6"/><path d="M19 7a9 9 0 0 1 0 10"/></svg>
          Mute
        </button>
      </div>
    </div>

    <pre id="status" class="status" aria-live="polite"></pre>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
  // -----------------------------
  // CONFIG — filenames remain EXACTLY as-is
  // -----------------------------
  const base = "Convention Center Videos/"; // trailing slash
  const STATES = {
    menu: {
      label: "Main Menu",
      loop: "menu_loop.mp4",
      to: {
        convention: { transition: "menu_to_convention.mp4" },
        expo:       { transition: "menu_to_expo.mp4" }
      }
    },
    convention: {
      label: "Convention Center",
      loop: "convention_loop.mp4",
      to: {
        menu: { transition: "convention_to_menu.mp4" },
        expo: { transition: "convention_to_expo.mp4" }
      }
    },
    expo: {
      label: "Expo Center",
      loop: "expo_loop.mp4",
      to: {
        menu: { transition: "expo_to_menu.mp4" },
        convention: { transition: "expo_to_convention.mp4" }
      }
    }
  };
  const DEFAULT_STATE = "menu";

  // Debug flag via URL ?debug=1
  const DEBUG = new URLSearchParams(location.search).get("debug") === "1";

  // UI refs
  const vidA = document.getElementById("vidA");
  const vidB = document.getElementById("vidB");
  const vidBuf = document.getElementById("vidBuf");
  const statusEl = document.getElementById("status");
  const btnReset = document.getElementById("btnReset");
  const btnContain = document.getElementById("btnContain");
  const btnMute = document.getElementById("btnMute");
  const destinationsWrap = document.getElementById("destinations");
  const toast = document.getElementById("toast");

  if (DEBUG){ statusEl.style.display = "block"; }

  // Simple logger
  function log(...args){
    if(!DEBUG) return;
    console.log(...args);
    statusEl.textContent = [statusEl.textContent, args.map(a=>typeof a==="string"?a:JSON.stringify(a)).join(" ")].filter(Boolean).join("\n").slice(-1800);
  }
  function showToast(msg, ms=1800){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", ms);
  }

  // Accessibility
  function setActiveButton(dest){
    for(const b of destinationsWrap.querySelectorAll("button")){
      const active = b.dataset.dest === dest;
      b.classList.toggle("active", active);
      b.setAttribute("aria-current", active ? "true" : "false");
    }
  }

  // Posters (use *_preview.jpg next to loop files)
  function posterFor(loopFile){
    return base + loopFile.replace(/\.mp4$/i, "_preview.jpg");
  }

  // HEAD with GET-range fallback only to *verify* existence (filenames unchanged).
  async function urlExists(url){
    try{
      let resp = await fetch(url, { method:'HEAD' });
      if(!resp.ok){
        resp = await fetch(url, { headers: { Range: "bytes=0-0" } });
      }
      return resp.ok;
    }catch(e){ return false; }
  }

  // Triple buffer management
  let active = vidA, next = vidB, buffer = vidBuf;
  function swap(){
    const oldActive = active;
    active.classList.add("hidden");
    next.classList.remove("hidden");
    buffer.classList.add("hidden");
    active = next;
    next = buffer;
    buffer = oldActive;
  }

  async function applyPoster(videoEl, loopFile){
    videoEl.setAttribute("poster", posterFor(loopFile));
  }

  // State
  let current = DEFAULT_STATE;
  let containMode = false;
  let muted = true;

  function setContainMode(on){
    containMode = !!on;
    for(const v of [vidA,vidB,vidBuf]){
      v.classList.toggle("contain", containMode);
    }
    btnContain.setAttribute("aria-pressed", containMode ? "true":"false");
    showToast(containMode ? "Fit content" : "Fill screen");
  }
  function setMuted(on){
    muted = !!on;
    for(const v of [vidA,vidB,vidBuf]) v.muted = muted;
    btnMute.setAttribute("aria-pressed", muted ? "true" : "false");
    showToast(muted ? "Muted" : "Sound on");
  }

  // Visibility save
  document.addEventListener("visibilitychange", ()=>{
    const vids = [active,next,buffer];
    if(document.hidden){ vids.forEach(v=>{ try{v.pause();}catch{} }); }
    else { try{ active.play(); }catch{} }
  });

  // Load / play helpers — use filenames exactly as provided
  async function playLoop(stateKey){
    const state = STATES[stateKey];
    const loopFile = state.loop;
    await applyPoster(next, loopFile);
    next.src = base + loopFile;
    next.loop = true;
    await next.play().catch(()=>{});
    swap();
    setActiveButton(stateKey);
    current = stateKey;
    saveSession();
    log("Loop:", stateKey, loopFile);
  }

  async function playTransition(fromKey, toKey){
    const from = STATES[fromKey];
    const to = STATES[toKey];
    const tInfo = from.to?.[toKey];
    if(!tInfo){ log("No transition mapping", fromKey, toKey); return playLoop(toKey); }

    const file = tInfo.transition; // use exact filename
    const ok = await urlExists(base + file);
    if(!ok){
      log("Transition missing, falling back to loop:", file);
      return playLoop(toKey);
    }

    buffer.removeAttribute("poster");
    buffer.loop = false;
    buffer.src = base + file;
    await buffer.play().catch(()=>{});

    buffer.onended = async ()=>{
      buffer.onended = null;
      await playLoop(toKey);
    };

    next.classList.add("hidden");
    active.classList.add("hidden");
    buffer.classList.remove("hidden");
    active.pause();
    log("Transition:", fromKey, "->", toKey, file);
  }

  function saveSession(){
    try{
      localStorage.setItem("cc_state", JSON.stringify({ current, containMode, muted }));
    }catch{}
  }
  function restoreSession(){
    try{
      const d = JSON.parse(localStorage.getItem("cc_state") || "null");
      if(!d) return;
      current = d.current || DEFAULT_STATE;
      setContainMode(!!d.containMode);
      setMuted(d.muted !== false); // default muted true
    }catch{}
  }

  // Build destination buttons (modern segmented style)
  function buildButtons(){
    destinationsWrap.innerHTML = "";
    Object.entries(STATES).forEach(([key, val])=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.dataset.dest = key;
      b.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path d="M4 12h16"/><path d="M12 4v16"/></svg>${val.label}`;
      b.setAttribute("aria-label", val.label);
      b.addEventListener("click", ()=>{
        if(key === current) return;
        disableDestinations(true);
        playTransition(current, key).finally(()=> disableDestinations(false));
      });
      destinationsWrap.appendChild(b);
    });
    setActiveButton(current);
  }
  function disableDestinations(disabled){
    destinationsWrap.querySelectorAll("button").forEach(b=> b.disabled = disabled);
  }

  // Controls
  btnReset.addEventListener("click", ()=>{
    playTransition(current, DEFAULT_STATE);
  });
  btnContain.addEventListener("click", ()=> setContainMode(!containMode));
  btnMute.addEventListener("click", ()=> setMuted(!muted));

  async function init(){
    restoreSession();
    buildButtons();
    setMuted(true);
    await playLoop(current);
    registerSW();
  }

  async function registerSW(){
    if("serviceWorker" in navigator){
      try{
        await navigator.serviceWorker.register("./cc-sw.js", { scope: "./" });
        log("SW registered");
      }catch(e){ log("SW failed", e); }
    }
  }

  window.addEventListener("load", init);
  </script>
</body>
</html>
